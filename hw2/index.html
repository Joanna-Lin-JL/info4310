<html>

    <script src="https://d3js.org/d3.v7.min.js"></script>


    <style>
            button {
                background-color: #04AA6D; 
                border: 1px solid green; 
                color: white; 
                padding: 10px 24px; 
                cursor: pointer; 
                float: left; 
                opacity: 0.7;
            }

            button:after {
                content: "";
                clear: both;
                display: table;
            }

            button:hover {
                background-color: #3e8e41;
            }

            #searchbar { 
                background-position: 10px 12px;
                background-repeat: no-repeat; 
                width: 100%; 
                font-size: 16px; 
                padding: 12px 20px 12px 40px; 
                border: 1px solid #ddd; 
                margin-bottom: 12px; 
            }

            #menuItems {
                list-style-type: none;
                padding: 0;
                margin: 0;
            }

            #menuItems li {
                border: 1px solid #ddd; 
                margin-top: -1px; 
                background-color: #f6f6f6;
                padding: 12px; 
                text-decoration: none; 
                font-size: 18px; 
                color: black; 
                display: block; 
            }

            #menuItems li:hover:not(.header) {
                background-color: #eee; 
            }

            .gridlines .domain {
                display: none;
            }
  
            .gridlines line {
                stroke: #e9e9e9;
            }

    </style>

    <body>
        <div style="margin:10px;">
            <div class="categories">
                <button id="all">All</button>
                <button id="breakfast">Breakfast</button>
                <button id="coffee">Coffee & Tea</button>
                <button id="smoothies">Smoothies & Shakes</button>
                <button id="chicken">Chicken & Fish</button>
                <button id="beverages">Beverages</button>
                <button id="beef">Beef & Pork</button>
                <button id="salads">Salads</button>
                <button id="snacks">Snacks & Sides</button>
                <button id="desserts">Desserts</button>
            </div>
            <br><br><br>
            <div class="yaxis">
                <button id="carbohydrates">Carbohydrates (g)</button>
                <button id="protein">Protein (g)</button>
                <button id="fat">Total Fat (g)</button>
                <button id="sodium">Sodium (mg)</button>
                <button id="sugars">Sugars (g)</button>
                <button id="fiber">Fiber (g)</button>
            </div>
            <br><br><br><br>
            <div class="search">
                <input type="text" id="searchbar" onkeyup="searchFilter()" placeholder="Search menu">
                <ul id="menuItems">
                </ul>
            </div>
            <br><br>
            <svg id="scatter" height="500" width="500">
                <text id = 'scatterText' x='250' y = '35' text-anchor='middle' alignment-baseline='center'></text>
                <text id= 'scatterX' text-anchor="middle"></text>
                <text id= 'scatterY' text-anchor="middle"></text>
                <text id = 'scatterTitle' x='250' y = '15' text-anchor='middle' alignment-baseline='center'></text>
            </svg>
            
            <svg id="pie" height="500" width="500">
                <text id = 'pieTitle' x='250' y = '15' text-anchor='middle' alignment-baseline='center'></text>
            </svg>
            <br><br><br>
            <a href="https://www.kaggle.com/datasets/mcdonalds/nutrition-facts/data">dataset</a>
            

            <script>
                const svg = d3.select("svg#pie");
                const scatter = d3.select('svg#scatter');
                const width = svg.attr('width');
                const height = svg.attr('height'); 
                const margin = {top: 30, right:10, bottom: 80, left:80}; 
                const chartWidth = width - margin.left - margin.right; 
                const chartHeight = height - margin.top - margin.bottom; 

                var filteredData = [];

                const pieRadius = chartWidth/2 - 10;
                const donutTranslateX = width/2; 
                const pieChart = svg.append('g').attr('transform', 'translate('+donutTranslateX+','+donutTranslateX+')');
            

                const requestData = async function() {

                    const data = await d3.csv("menu.csv", d3.autoType);
                    filteredData = data;
                    var scatterXName = "Calories";
                    var scatterYName = "Sodium"; 
                    var categorySelected = "All";
                    var itemSelected = data[0].Item;

                    console.log(data);

                    categories = {
                        "Breakfast": [],
                        "Coffee & Tea": [],
                        "Smoothies & Shakes": [], 
                        "Chicken & Fish": [], 
                        "Beverages": [], 
                        "Beef & Pork": [], 
                        "Salads": [], 
                        "Snacks & Sides": [], 
                        "Desserts": []
                    }

                    data.forEach ( d => {
                        categories[d.Category].push(d);
                    });

                    var items = data.map( d => d.Item );

                    var nutritionData = {
                        "Protein": 0, 
                        "Carbohydrates": 0, 
                        "Total Fat": 0, 
                        "Dietary Fiber": 0, 
                        "Sugars": 0
                    }

                    var colorScale = d3.scaleOrdinal()
                    .domain(Object.keys(nutritionData))
                    .range(d3.schemeSet2);

                    d3.select("#pieTitle")
                        .style('font-size', 17)
                        .text(itemSelected);

                    updateNutritionData(data[0]);

                    updatePie();

                    var select = document.getElementById("menuItems");

                    for (var i = 0; i < items.length; i++) {
                        var option = items[i];
                        var element = document.createElement("li");
                        element.appendChild(document.createTextNode(option));
                        element.onclick = function(){searchBarClicked(this)};
                        element.style.display = "none";
                        select.appendChild(element);
                    }

                    function updatePie() {
                        const pie = d3.pie()
                                .value(function(d) {return d[1]})
                                .sort(function(a, b) { return d3.ascending(a.key, b.key);} )

                        const pieData = pie(Object.entries(nutritionData));

                        const piePath = pieChart.selectAll("path").data(pieData);

                        const arcGenerator = d3.arc()
                        .innerRadius(0)
                        .outerRadius(pieRadius);

                        piePath.join('path')
                        .transition()
                        .duration(500)
                        .attr('d', arcGenerator)
                        .attr('fill', function(d){ return(colorScale(d.data[0])) })
                        .attr("stroke", "white")
                        .style("stroke-width", "2px")
                        .style("opacity", 1);

                        pieChart.selectAll('text')
                        .data(pieData)
                        .join('text')
                        .text(function(d){ return d.data[0]})
                        .attr("transform", function(d) { return "translate(" + arcGenerator.centroid(d) + ")";  })
                        .style("text-anchor", "middle")
                        .style("font-size", 12);

                        d3.select("#pieTitle")
                            .text(itemSelected);
                    }

                    function searchBarClicked (e) {
                        let name = e.innerText;
                        let input = document.getElementById('searchbar');
                        input.value = name;
                        let lst = document.getElementById('menuItems');
                        lst.setAttribute('hidden', 'hidden');
                        updateNutritionData(data.filter(d => d.Item === name)[0]);
                        itemSelected = name;
                        updatePie();
                    }

                    let allbutton = document.getElementById("all");
                    let breakfast = document.getElementById("breakfast");
                    let coffee = document.getElementById("coffee");
                    let smoothies = document.getElementById("smoothies");
                    let chicken = document.getElementById("chicken");
                    let beverages = document.getElementById("beverages");
                    let beef = document.getElementById("beef");
                    let salads = document.getElementById("salads");
                    let snacks = document.getElementById("snacks");
                    let desserts = document.getElementById("desserts");

                    let categoryButtons = [allbutton, breakfast, coffee, smoothies, chicken, beverages, beef, salads, snacks, desserts]

                    allbutton.addEventListener('click', function () {categoryButtonClicked(this, 'all')});
                    breakfast.addEventListener('click', function () {categoryButtonClicked(this, 'Breakfast')});
                    coffee.addEventListener('click', function (){categoryButtonClicked(this, 'Coffee & Tea')});
                    smoothies.addEventListener('click', function (){categoryButtonClicked(this, 'Smoothies & Shakes')});
                    chicken.addEventListener('click', function (){categoryButtonClicked(this, 'Chicken & Fish')});
                    beverages.addEventListener('click', function (){categoryButtonClicked(this, 'Beverages')});
                    beef.addEventListener('click', function (){categoryButtonClicked(this, 'Beef & Pork')});
                    salads.addEventListener('click', function (){categoryButtonClicked(this, 'Salads')});
                    snacks.addEventListener('click', function (){categoryButtonClicked(this, 'Snacks & Sides')});
                    desserts.addEventListener('click', function (){categoryButtonClicked(this, 'Desserts')});
                    
                    allbutton.style.opacity = 1;
                    allbutton.style.borderColor = "red";

                    function categoryButtonClicked (e, name) {
                        categoryButtons.forEach ( d => {
                            d.style.opacity = 0.7; 
                            d.style.borderColor = "green";
                        })
                        e.style.opacity = 1;
                        e.style.borderColor = "red";
                        categorySelected = name;
                        // document.getElementById('searchbar').value = "";
                        if (name === 'all') {
                            filteredData = data;
                        } else {
                            filteredData = data.filter( d => d.Category === name);
                        }
                        updateScatter(scatterXName, scatterYName);
                    }

                    function updateNutritionData(item) {
                        Object.keys(nutritionData).forEach( k => {
                            nutritionData[k] = item[k]; 
                        })
                        nutritionData['Carbohydrates'] -= nutritionData["Dietary Fiber"] - nutritionData["Sugars"]; // assume carbs included the two
                    }

                    let carbohydrates = document.getElementById("carbohydrates"); 
                    let protein = document.getElementById("protein");
                    let fat = document.getElementById("fat");
                    let sodium = document.getElementById("sodium");
                    let sugars = document.getElementById("sugars");
                    let fiber = document.getElementById("fiber");

                    let yaxisButtons = [carbohydrates, protein, fat, sodium, sugars, fiber];

                    carbohydrates.addEventListener('click', function () {yaxisButtonClicked(this, 'Carbohydrates')});
                    protein.addEventListener('click', function () {yaxisButtonClicked(this, 'Protein')});
                    fat.addEventListener('click', function () {yaxisButtonClicked(this, 'Total Fat')});
                    sodium.addEventListener('click', function () {yaxisButtonClicked(this, 'Sodium')});
                    sugars.addEventListener('click', function () {yaxisButtonClicked(this, 'Sugars')});
                    fiber.addEventListener('click', function () {yaxisButtonClicked(this, 'Dietary Fiber')});

                    sodium.style.opacity = 1;
                    sodium.style.borderColor = "red";

                    function yaxisButtonClicked (e, xname) {
                        yaxisButtons.forEach ( d => {
                            d.style.opacity = 0.7; 
                            d.style.borderColor = "green";
                        })
                        e.style.opacity = 1;
                        e.style.borderColor = "red";
                        scatterYName = xname; 
                        updateScatter();
                    }

                    let scatterLabels = scatter.append('g')
                                    .attr('id', 'scatterLabels');

                    let yaxis = scatterLabels.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margin.left-10},${margin.top})`);

                    let ygridlines = scatterLabels.append('g')
                        .attr('class', 'y gridlines')
                        .attr('transform', `translate(${margin.left-10},${margin.top})`)
                        .lower();

                    let xaxis = scatterLabels.append('g')
                        .attr('class', 'x axis')
                        .attr('transform', `translate(${margin.left},${chartHeight+margin.top+10})`);

                    let xgridlines = scatterLabels.append('g')
                        .attr('class', 'x gridlines')
                        .attr('transform', `translate(${margin.left},${chartHeight+margin.top+10})`)
                        .lower();

                    let scatterChart = scatter.append('g')
                                .attr('transform',`translate(${margin.left},${margin.top})`);

                    d3.select("#scatterX")
                            .attr("x", chartWidth / 2 + 50)
                            .attr("y", chartHeight + 75)
                            .style('font-size', '15px')
                            .text(`${scatterXName} + (kcals)`)
                            // .text(scatterXName + " (kcals)");

                    
                    d3.select("#scatterY")
                            .attr("x", -chartHeight/2 - 50)
                            .attr("y", 25)
                            .style("font-size", "15px")
                            .attr("transform", "rotate(-90)")
                            .text(scatterYName);

                    d3.select("#scatterTitle")
                        .style("font-size", 17)
                        .text(categorySelected);

                    d3.select('#scatterText').style.fontSize = 10;
                        

                    updateScatter(scatterXName, scatterYName);


                    function updateScatter (){
                        const xExtent = d3.extent(filteredData, d => d[scatterXName] );
                        const xScale = d3.scaleLinear().domain(xExtent).range([0, chartWidth]);

                        const yExtent = d3.extent(filteredData, d => d[scatterYName]);
                        const yScale = d3.scaleLinear().domain(yExtent).range([chartHeight, 0]);

                        let leftAxis = d3.axisLeft(yScale);
                        let leftGridlines = d3.axisLeft(yScale)
                        .tickSize(-chartWidth-10)
                        .tickFormat("");

                        let bottomAxis = d3.axisBottom(xScale);
                        let bottomGridlines = d3.axisBottom(yScale)
                        .tickSize(-chartHeight-10)
                        .tickFormat('');

                        yaxis.call(leftAxis);
                                
                        ygridlines.call(leftGridlines);

                        xaxis.call(bottomAxis);
                                
                        xgridlines.call(bottomGridlines);

                        let points = scatterChart.selectAll('circle.dot')
                        .data(filteredData)
                        .join('circle')
                        .attr('class', 'dot')
                        .attr('cx', d => xScale(d[scatterXName]))
                        .attr('cy', d => yScale(d[scatterYName]))
                        .attr('r', 7)
                        .attr('stroke-width', 0)
                        .attr('fill', 'blue')
                        .style('opacity', 0.7)
                        .on('mouseover', function(){
                            d3.select(this)
                            .transition().duration(200)
                            .attr("stroke-width", 1)
                            .attr("stroke", "black")
                            .attr('fill', 'red')
                            .attr("opacity", 1)
                            .attr("r", 10);

                            let item = d3.select(this).datum()['Item']
                                
                            d3.select('#scatterText')
                                .text(item)
                                .lower();
                        })
                        .on('mouseout', function(e) {
                            d3.select(this)
                            .transition().duration(200)
                            .attr("stroke-width", 0)
                            .attr("stroke", "none")
                            .attr("opacity", 0.7)
                            .attr('fill', 'blue')
                            .attr("r", 7);
                                
                            d3.select('#scatterText')
                                .text("")
                                .lower();
                        })
                        .on('click', function(e) {
                            let d = d3.select(this).datum();
                            updateNutritionData(d);
                            itemSelected = d.Item;
                            document.getElementById('searchbar').value = d.Item;
                            updatePie();
                        })

                        let yUnit = scatterYName==="Sodium"? "(mg)" : "(g)"; 

                        d3.select("#scatterY").text(`${scatterYName} ${yUnit}`);
                        d3.select("#scatterX").text(`${scatterXName} (kcals)`);
                        d3.select("#scatterTitle").text(categorySelected);
                    }
                }; 

                requestData(); 

                function searchFilter() {
                    let input = document.getElementById('searchbar').value.toLowerCase();
                    let lst = document.getElementById('menuItems');
                    let lstItems = document.getElementsByTagName('li');
                    
                    if (input){
                        if (lst.getAttribute('hidden')){
                            lst.removeAttribute('hidden');
                        }
                        for (i = 0; i < lstItems.length; i++) {
                            text = lstItems[i].textContent;
                            if (text.toLowerCase().includes(input)) {
                                lstItems[i].style.display = "";
                            } else {
                                lstItems[i].style.display = "none";
                            }
                        }
                    } else {
                        lst.setAttribute ('hidden', 'hidden');
                    }
                }

                
            
            </script>
        </div>
    </body>
</html>
