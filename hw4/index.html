<html>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>


    <style>
        .searchbar { 
            background-position: 10px 12px;
            background-repeat: no-repeat; 
            width: 50%; 
            font-size: 16px; 
            padding: 12px 20px 12px 40px; 
            border: 1px solid #ddd; 
            margin-bottom: 12px; 
        }

        .items {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .items li {
            border: 1px solid #ddd; 
            margin-top: -1px; 
            background-color: #f6f6f6;
            padding: 12px; 
            text-decoration: none; 
            font-size: 18px; 
            color: black; 
            display: block; 
        }

        .items li:hover:not(.header) {
            background-color: #eee; 
        }
        

    </style>

    <body>
        <div style="margin:10px;">
            <h1>Most popular cat and dog names in the UK</h1>
            <p>*Disclaimer: data may be skewed due to sourcing from an insurance company</p><br>
            <div>
                <h2>Dog</h2>
                <input type="text" id="dogsearchbar" class="searchbar" onkeyup="searchFilter('dog')" placeholder="Search dog name">
                <ul id="dognames" class="items">
                </ul>
                <br>
                <svg id="dog" height="500" width="650" >
                </svg>
                
                </div>
                <input type="text" id="catsearchbar" class="searchbar" onkeyup="searchFilter('cat')" placeholder="Search cat name">
                <ul id="catnames" class="items">
                </ul>
                <h2>Cat</h2>
                <svg id="cat" height="500" width="650" >
                </svg>
                
            </div>
            

            <script>
                let dogsvg = d3.select('#dog');
                let catsvg = d3.select('#cat');
                
                // let svgs = [dogsvg, catsvg, dogbreedsvg, catbreedsvg];
                let svgs = [dogsvg, catsvg];
                const width = dogsvg.attr('width');
                const height = dogsvg.attr('height'); 
                const margin = {top: 10, right: 100, bottom: 100, left: 100};
                const graphWidth = width - margin.right - margin.left; 
                const graphHeight = height - margin.top - margin.bottom;
                let graphs = svgs.map(d => {return d.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');} );
                
                const requestData = async () => {
                    var dogData = await d3.csv("dog.csv", d3.autoType);
                    var catData = await d3.csv("cat.csv", d3.autoType);
                    var dogBreedData = await d3.csv("dog_breed.csv", d3.autoType);
                    var catBreedData = await d3.csv("cat_breed.csv", d3.autoType);
                    let data = [dogData, catData];
                    let displayData = [dogData.slice(0, 7), catData.slice(0, 7)];
                    let breedData = [dogBreedData, catBreedData];

                    console.log(data);

                    var categorized = []
                    let select = [document.getElementById("dognames"), document.getElementById("dognames")];
                    let liNames = ['dogli', 'catli']

                    data.forEach( (d, i) => {
                        var sub = {};
                        d.forEach( dd => {
                            let name = dd['Name'];
                            var lst = breedData[i].filter(ddd => ddd['Name'] === dd.Name)
                            lst.push( {
                                "Breed": "other", 
                                "Name": name, 
                                "Number": (dd['Number']-lst.map(ddd => ddd['Number']).reduce(
                                                    (acc, curr) => acc + curr, 0))
                                                })
                            sub[name] = lst; 

                            var option = dd;
                            var element = document.createElement("li");
                            element.className = liNames[i];
                            element.appendChild(document.createTextNode(option['Name']));
                            element.onclick = function(){searchBarClicked(this, i)};
                            element.style.display = "none";
                            select[i].appendChild(element);
                        })
                        categorized.push(sub);
                    })
                    
                    

                    graphs.forEach ( (g, i) => {
                        let extent = d3.extent(displayData[i], d => d['Number'])
                        let scale = d3.scaleLinear().domain([0, extent[1]]).range([0, graphWidth]);

                        let xLabels = g.append('g')
                        .attr('class', 'xlabels')
                        .attr("transform", `translate(0, ${graphHeight})`)
                        .call(d3.axisBottom(scale))
                        .selectAll("text")
                        .attr("transform", "translate(-10,0)rotate(-45)")
                        .style("text-anchor", "end");

                        let yAxis = d3.scaleBand()
                            .range([ 0, graphHeight ])
                            .domain(displayData[i].map(d => d.Name))
                            .padding(.1);

                        let yLabels = g.append("g")
                            .attr('class', 'xlabels')
                            .call(d3.axisLeft(yAxis))
                            .style('font-size', 15)
                            .style('font-weight', 'bold');

                        updateGraph(g, i);
                    })

                    function updateGraph(g, i){
                        let extent = d3.extent(displayData[i], d => d['Number'])
                        let scale = d3.scaleLinear().domain([0, extent[1]]).range([0, graphWidth]);

                        let xLabels = g.select('g.xlabels')
                        .call(d3.axisBottom(scale))

                        let yAxis = d3.scaleBand()
                            .range([ 0, graphHeight ])
                            .domain(displayData[i].map(d => d.Name))
                            .padding(.1);

                        g.select('g.ylabels')
                        .call(d3.axisLeft(yAxis))

                        g.selectAll("rect.bars")
                            .data(displayData[i])
                            .join("rect")
                            .attr('class', 'bars')
                            .attr("x", scale(0))
                            .attr("y", d => yAxis(d['Name']))
                            .attr("width", d => scale(d['Number']))
                            .attr("height", yAxis.bandwidth())
                            .attr("fill", "#69b3a2")
                            .attr('opacity', 0.8)
                            .on('mouseover', function(){
                                let dat = d3.select(this).datum();
                                let filtered = categorized[i][dat['Name']];
                                let colorScale = d3.scaleOrdinal(d3.schemeCategory10);
                                filtered.forEach ( (d, i) => {
                                    let prevSum = filtered.slice(0, i).map(d => d['Number']).reduce(
                                                    (acc, curr) => acc + curr, 0);
                                    g.append('rect')
                                    .attr('id', 'breedbar')
                                    .attr('class', 'subbar')
                                    .attr('fill', filtered[i]['Breed'] === 'other' ? 'gray' : colorScale(filtered[i]['Breed']))
                                    .attr('x', scale(prevSum))
                                    .attr('y', yAxis(dat['Name']))
                                    .attr('height', yAxis.bandwidth())
                                    .attr('width', scale(filtered[i]['Number']))
                                    .on('mouseout', function(){
                                        d3.selectAll('rect.subbar').remove();
                                    })
                                })
                             })

                        // g.selectAll('text.bars').each( function () {
                        //     d3.select(this).remove();
                        // });
                        g.selectAll('text.bars')
                        .data(displayData[i])
                        .join('text')
                        .attr('class', 'bars')
                        .attr('font-size', 12)
                        .attr('x', function (d) {return scale(d['Number'] + scale(0) + 50)})
                        .attr("y", function (d) {return yAxis(d['Name']) + yAxis.bandwidth()/2})
                        .style('text-anchor', 'start')
                        .text(function (d) {return d['Number']})
                        
                    }

                    let inputs = [document.getElementById('dogsearchbar'), document.getElementById('catsearchbar')];
                    let lsts = [document.getElementById('dognames'), document.getElementById('catnames')]

                    function searchBarClicked(ele, i) {
                        let name = ele.innerText;
                        let c = ele.className;
                        let input = inputs[i];
                        let lst = lsts[i];

                        input.value = name;
                        lst.setAttribute('hidden', 'hidden');
                        let result = data[i].find(({ Name }) => Name === name);
                        if (displayData[i].includes(result)) return;
                        
                        displayData[i].push(result);
                        displayData[i] = displayData[i].sort((a, b) => a['Number']<b['Number']);
                        updateGraph(graphs[i], i);
                    }

                }
                
                requestData();

                function searchFilter(type) {
                    let input = document.getElementById('dogsearchbar').value.toLowerCase();
                    let lst = document.getElementById('dognames');
                    let lstItems = document.getElementsByClassName('dogli');

                    if (type==='cat'){
                        input = document.getElementById('catsearchbar').value.toLowerCase();
                        lst = document.getElementById('catnames');
                        lstItems = document.getElementsByClassName('catli');
                    }
                    
                    if (input){
                        if (lst.getAttribute('hidden')){
                            lst.removeAttribute('hidden');
                        }
                        for (i = 0; i < lstItems.length; i++) {
                            text = lstItems[i].textContent;
                            if (text.toLowerCase().includes(input)) {
                                lstItems[i].style.display = "";
                            } else {
                                lstItems[i].style.display = "none";
                            }
                        }
                    } else {
                        lst.setAttribute ('hidden', 'hidden');
                    }
                }

            </script>
        </div>
    </body>
</html>
